<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Login History"
    description="Display users login history and statistic">
    <Require feature="dynamic-height" />
    <Locale messages="locale/default.xml" />
    <Locale lang="fr" messages="locale/fr.xml" />
    <Locale lang="es_ES" messages="locale/es_ES.xml" />
    <Locale lang="vi" messages="locale/vi.xml" />
    <Locale lang="sv_SE" messages="locale/sv_SE.xml"/>
    <Locale lang="ja" messages="locale/ja.xml"/>
    <Locale lang="ar" messages="locale/ar.xml"/>
    <Locale lang="de" messages="locale/de.xml"/>
    <Locale lang="pt_BR" messages="locale/pt_BR.xml"/>
    <Locale lang="it" messages="locale/it.xml"/>
    <Locale lang="ru" messages="locale/ru.xml"/>
    <Locale lang="tr" messages="locale/tr.xml"/>
    <Locale lang="zh_CN" messages="locale/zh_CN.xml"/>
    <Locale lang="zh_TW" messages="locale/zh_TW.xml"/>
    <Locale lang="lt" messages="locale/lt.xml"/>
    <Locale lang="cs" messages="locale/cs.xml"/>
    <Locale lang="uk" messages="locale/uk.xml"/>
    <Locale lang="no" messages="locale/no.xml"/>
    <Locale lang="el" messages="locale/el.xml"/>
    <Locale lang="pl" messages="locale/pl.xml"/>
    <Locale lang="fa" messages="locale/fa.xml"/>
    <Locale lang="ro" messages="locale/ro.xml"/>
    <Locale lang="ca" messages="locale/ca.xml"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[       
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
      
        <link rel="stylesheet" type="text/css" href="/eXoSkin/skin/css/Core.css" />
        <link rel="stylesheet" type="text/css" href="/eXoSkin/skin/css/platform/portlets/samples/gadgets-sample/exo-gadget-resources/gadget-common.css" />
        <link rel="stylesheet" type="text/css" href="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/jquery.jqplot.min.css" />
        <link rel="stylesheet" type="text/css" href="/exo-gadget-resources/skin/flexigrid/flexigrid.custom.css" />
        <link rel="stylesheet" type="text/css" href="/eXoSkin/skin/css/platform/portlets/gadget-pack/loginHistory-jquery-ui-1.8.13.custom.css" />
        <link rel="stylesheet" type="text/css" href="/eXoSkin/skin/css/platform/portlets/gadget-pack/loginHistory.css" />
        <script language="javascript" type="text/javascript" src="/eXoResources/javascript/jquery-1.7.1.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/date.js/date.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jquery.timers/1.2/jquery.timers.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/flexigrid/1.1/js/flexigrid.pack.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/jquery.jqplot.min.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/plugins/jqplot.barRenderer.min.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/plugins/jqplot.categoryAxisRenderer.min.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/plugins/jqplot.highlighter.min.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/jquery/plugins/jqplot/1.0.5/plugins/jqplot.pointLabels.min.js"></script>
        <script language="javascript" type="text/javascript" src="/exo-gadget-resources/script/utils/pretty.date.js"></script>
        <script language="javascript" type="text/javascript" src="script/jquery-ui-1.8.13.custom.min.js"></script>
        <script language="javascript" type="text/javascript" src="script/jquery-datatables.min.js"></script>
        <script language="javascript" type="text/javascript" src="/eXoResources/skin/bootstrap/js/bootstrap-collapse.js"></script>
        <script language="javascript" type="text/javascript">
          var selectedUser = "AllUsers", selectedUserName = "__MSG_loginHistory.allUsers__";
          var $lastLoginsDataBackup;
          var isFinding = false;
          
          Array.prototype.sum = function() {
            return this.reduce(function(a,b){return a+b;});
          };
                
          function GetColumnSize(percent){
              screen_res = $(window).width();
              col = parseInt((percent*(screen_res/100)));
              if (percent != 100){
                  return col-12;
              }else{
                  return col;
              }
          }
      
          function getQuarter(date){
            var d = new Date(date);
            var quarter = Math.ceil((d.getMonth() + 1) / 3);
            var quarterStartMonth;
            switch (quarter) {
              case 1:
                quarterStartMonth = Date.parse("Jan 01 " + d.getFullYear());
                break;
              case 2:
                quarterStartMonth = Date.parse("Apr 01 " + d.getFullYear());
                break;
              case 3:
                quarterStartMonth = Date.parse("Jul 01 " + d.getFullYear());
                break;
              case 4:
                quarterStartMonth = Date.parse("Oct 01 " + d.getFullYear());
                break;
              default:
                break;
            }
            return {"number":quarter, "date":quarterStartMonth.getTime()};
          }
       /*
     * (function ($) { $.fn.styleTable = function (options) {
     * $("#lastLoginsTable").flexigrid({ // title: '<center>Lastest login</center>',
     * colModel : [ {display: "__MSG_loginHistory.user__", name : 'user',
     * width: GetColumnSize(20), align: 'left'}, {display:
     * "__MSG_loginHistory.lastLogin__", name : 'lastLogin', width:
     * GetColumnSize(29), align: 'center'}, {display:
     * "__MSG_loginHistory.beforeThat__", name : 'beforeThat', width:
     * GetColumnSize(29), align: 'center'}, {display:
     * "__MSG_loginHistory.more__", name : 'more', width :
     * GetColumnSize(22), align: 'center'} ], showTableToggleBtn: true,
     * singleSelect: true, resizable: true, nowrap: false, striped: true,
     * width: "auto", height: $(this).height() > 120 ? 210 : 120, }); };
     * })(jQuery);
     */
          function lastLogins2html(lastLoginsJson){
            $("#lastLoginsDataDiv").remove();
            $lastLoginsDataBackup.clone().appendTo($("#lastLoginsContainerDiv"));
            $('#lastLoginsTable').find("tr:gt(0)").remove();
            $.each(lastLoginsJson.data, function(i,login){
              var newRow = $( "<tr " + "id='"+login.userId+"'" + ">" +
                              "<td ><a href='#' class='detailUser'>" + login.userName.replace(/ /g, "&nbsp;") + "</a></td>" +
                "<td >" + (login.lastLogin > new Date().getTime() ? "next " + prettyTimeDiff(login.lastLogin, true) : prettyTimeDiff(login.lastLogin, true) + " ago") + "</td>" +
                "<td >" + (login.beforeLastLogin == 0 ? "__MSG_loginHistory.unknow__" : (login.beforeLastLogin > new Date().getTime() ? "next " + prettyTimeDiff(login.beforeLastLogin, true) : prettyTimeDiff(login.beforeLastLogin, true) + " ago")) + "</td>" +
                "</tr>");
              $('#lastLoginsTable').append(newRow);
            });
            var oTable = $('#lastLoginsTable').dataTable({ "bFilter": false, "bPaginate": false,"bInfo": false, });
            oTable.fnSort( [ [2,'asc']] );
            $lastLoginsDataBackup = $("#lastLoginsDataDiv").clone();
          // $("#lastLoginsTable").styleTable();
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          }
        
          function loginHistory2Html(loginHistoryJson){
            var loginHistory = loginHistoryJson.data[1];
            var loginHistoryHtml = "";
            loginHistoryHtml += '<div class="accordion-inner"> <table>';
            if (selectedUser == "AllUsers") {              
              $.each(loginHistory, function(i, loginHistory){
                loginHistoryHtml += "<tr>";
                loginHistoryHtml += "<td class='loginHistoryItem'>" + "<a href='#' id='" + loginHistory.userId + "' class='customLink'>" + loginHistory.userName.replace(/ /g, "&nbsp;") + "</a>"+"</td>";
                // "&nbsp;-&nbsp;" + (loginHistory.loginTime > new Date().getTime() ? "next&nbsp;" + prettyTimeDiff(loginHistory.loginTime, true) : prettyTimeDiff(loginHistory.loginTime, true) + "&nbsp;ago").replace(/ /g, "&nbsp;") +
                loginHistoryHtml += "<td class='loginHistoryItemDetail'>"  + new Date(loginHistory.loginTime).toString("ddd dd MMM yyyy hh:mm tt") + "</td>";
                loginHistoryHtml += "</tr>";
              });
            } else {
              $.each(loginHistory, function(i, loginHistory){
                loginHistoryHtml += "<tr>";
                //loginHistoryHtml += "<div class='loginHistoryItem'>" + (loginHistory.loginTime > new Date().getTime() ? "next " + prettyTimeDiff(loginHistory.loginTime) : prettyTimeDiff(loginHistory.loginTime) + " ago") + "</div>";
                loginHistoryHtml += "<td class='loginHistoryItemDetail'>" + new Date(loginHistory.loginTime).toString("ddd dd MMM yyyy hh:mm tt") + "</td>";
                loginHistoryHtml += "</tr>";
              });
            }
            loginHistoryHtml += '</table></div>';                       
            return loginHistoryHtml;
          }
      
          function drawChart($chart, data, ticks){
            $chart.html("");
            
            plot1 = $.jqplot($chart.attr("id"), [data], {
                seriesDefaults:{
                    shadow: false,
                    color: "#226aa1",
                    renderer:$.jqplot.BarRenderer,
                    rendererOptions:{
                       barWidth:15
                    },
                    pointLabels: {show: true, hideZeros: true, ypadding: 0}
                },
                axesDefaults:{
                    tickOptions: {
                        markSize: 3,
                        showGridline: true
                    }
                },
                axes: {
                    xaxis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        ticks: ticks,
                        tickOptions: {
                //formatString: '%d',
                        }
                    },
                    yaxis: {
                        min: 0,
                //tickInterval: 1,
                        tickOptions: {
                            formatString: '%d',
                        }
                    }
                },
                grid:{borderColor:'transparent',   
            	    shadow: false,
                    background: '#F2F2F2'},
                highlighter: {show: false, tooltipFadeSpeed:'slow', tooltipLocation:'n'}
            });
            
            $(window).unbind();
            $(window).resize(function(){
      // $('#loginStatsChart').css("width", $(window).width());
      // $('#loginStatsChart').css("height", $(window).height()*0.7);
              plot1.replot();
            });
          };
              
      
          function showSelectedDayLogins(userId, day){
            var d = new Date(day);
            var restURI = "/rest/loginhistory/loginhistory/"+ userId + "/" + day + "/" + (day+86400000);
            $.getJSON(restURI, function(userLoginHistoryPositionJson){
              $("#selectedDayHeaderContainer").show();
              $("#selectedDayHeader").text(d.toString("ddd MMM dd yyyy") + " (" + userLoginHistoryPositionJson.data[0] + ")");
              $("#selectedDayDiv").html(loginHistory2Html(userLoginHistoryPositionJson));
       // $("#accordion").accordion("option", "active", 0);              
            });            
          }
      
          function showTodayLogins(userId){
            var restURI = "/rest/loginhistory/loginhistory/"+ userId + "/" + Date.today().getTime() + "/" + Date.today().setTimeToNow().getTime();
            $.getJSON(restURI, function(userLoginHistoryPositionJson){
              $("#todayHeader a span").text("__MSG_loginHistory.today__ (" + userLoginHistoryPositionJson.data[0] + ")");
              $("#todayDiv").html(loginHistory2Html(userLoginHistoryPositionJson));
              // $("#accordion").accordion("option", "active", 1);   
              gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
            });
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          }
          
          function showEarlierThisWeekLogins(userId){
            var restURI = "/rest/loginhistory/loginhistory/"+ userId + "/" + Date.monday().getTime() + "/" + Date.today().getTime();
            $.getJSON(restURI, function(userLoginHistoryPositionJson){
              $("#earlierThisWeekHeader a span").text('__MSG_loginHistory.earlierThisWeek__ (' + userLoginHistoryPositionJson.data[0] + ')');
              $("#earlierThisWeekDiv").html(loginHistory2Html(userLoginHistoryPositionJson));
            });            
          }
      
          function showEarlierThisMonthLogins(userId){
            var restURI = "/rest/loginhistory/loginhistory/"+ userId + "/" + Date.today().moveToFirstDayOfMonth().getTime() + "/" + Date.monday().getTime();
            $.getJSON(restURI, function(userLoginHistoryPositionJson){
              $("#earlierThisMonthHeader a span").text('__MSG_loginHistory.earlierThisMonth__ (' + userLoginHistoryPositionJson.data[0] + ')');
              $("#earlierThisMonthDiv").html(loginHistory2Html(userLoginHistoryPositionJson));
            });            
          }
          
          function showEarlierLogins(userId){
            var restURI = "/rest/loginhistory/loginhistory/"+ userId + "/" + 0 + "/" + Date.today().moveToFirstDayOfMonth().getTime();
            $.getJSON(restURI, function(userLoginHistoryPositionJson){
              $("#earlierHeader a span").html('__MSG_loginHistory.earlier__ (' + userLoginHistoryPositionJson.data[0] + ')');
              $("#earlierDiv").html(loginHistory2Html(userLoginHistoryPositionJson));
            });            
          }
          
      
          function showDailyStats(userId, week){
            var currentWeek = new Date(week);
            var restURI = "/rest/loginhistory/weekstats/"+ userId + "/" + currentWeek.toString("yyyy-MM-dd");
            $.getJSON(restURI, function(userLoginCountJson){
              var loginCountPerDays = userLoginCountJson.data[1];
              var weekDays = new Array();
              var counts = new Array();
              var counted = 0;
              $.each(loginCountPerDays, function(i, loginCountPerDay){
                weekDays.push(new Date(loginCountPerDay.loginDate).toString("ddd"));
                if(loginCountPerDay.loginCount != -1){
                  counts.push(loginCountPerDay.loginCount);
                  counted++;
                } else{
                  counts.push(0);
                }
              });
              var titleWeek = (currentWeek.getWeek() == 1 && currentWeek.getMonth() == 11) ? currentWeek.clone().next().monday() : currentWeek;
              var month = titleWeek.clone().moveToFirstDayOfMonth();
              var monthLink = "<a class='chartTitleLink' href='#monthstats/" + month.getTime() + "'>" + month.toString("MMM") + "</a>";
              var year = titleWeek.getFullYear();
              var yearLink = "<a class='chartTitleLink' href='#yearstats/" + Date.parse("Jan 01 " + year).getTime() + "'>" + year + "</a>";
              var quarter = getQuarter(titleWeek.getTime());
              var quarterLink = "<a class='chartTitleLink' href='#quarterstats/" + quarter.date + "'>" + "Q" + quarter.number + "</a>";
              var chartTitle = "__MSG_loginHistory.week__ " + currentWeek.getWeek() ;
              $("#loginStatsChartTitle").html(chartTitle);
              drawChart($("#loginStatsChart"), counts, weekDays);
              $("#stats").html("__MSG_loginHistory.averagePerDay__: " + (counted == 0 ? 0 : (counts.sum()/counted)).toFixed(2));
              gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
            });
            
            $("#prevBtn").unbind();
            $("#prevBtn").click(function(){
              currentWeek.last().monday();
              showDailyStats(userId, currentWeek.getTime());
            })
            
            $("#nextBtn").unbind();
            $("#nextBtn").click(function(){
              currentWeek.next().monday();
              showDailyStats(userId, currentWeek.getTime());
            })
            
            $("#loginStatsChart").unbind();
            
            $("#loginStatsChart").bind('jqplotDataClick',
              function (ev, seriesIndex, pointIndex, data) {
                $(this).css('cursor','auto');
                showHistory(selectedUser, currentWeek.clone().addDays(pointIndex).getTime());
              }
            );
      
            $('#loginStatsChart').bind('jqplotDataHighlight',
                function (ev, seriesIndex, pointIndex, data ) {
                    mouseX = ev.pageX;
                    mouseY = ev.pageY;
                    $('#chartTooltipDiv').html(currentWeek.clone().addDays(pointIndex).toString("MMM dd, yyyy"));
                    $('#chartTooltipDiv').fadeIn();
                    var cssObj = {
                          'position' : 'absolute',
                          'left' : mouseX + 'px',
                          'top' : mouseY-15 + 'px'
                        };
                    $('#chartTooltipDiv').css(cssObj);
                    $(this).css('cursor','pointer');
                }
            );
      
            $('#loginStatsChart').bind('jqplotDataUnhighlight',
                function (ev) {
                    $('#chartTooltipDiv').html('');
                    $('#chartTooltipDiv').hide();
                    $(this).css('cursor','auto');
                }
            );
          }
                
          function showWeeklyStats(userId, fromMonth, numOfMonths){
            var currentMonth = new Date(fromMonth);
            var weeks = new Array();
            var restURI = "/rest/loginhistory/monthstats/"+ userId + "/" + currentMonth.toString("yyyy-MM-dd") + "/" + numOfMonths;
            $.getJSON(restURI, function(userLoginCountJson){
              var loginCountPerWeeks = userLoginCountJson.data[1];
              var counts = new Array();
              var counted = 0;
              $.each(loginCountPerWeeks, function(i, loginCountPerWeek){
                weeks.push(new Date(loginCountPerWeek.loginDate).getWeek());
                if(loginCountPerWeek.loginCount != -1){
                  counts.push(loginCountPerWeek.loginCount);
                  counted++;
                } else{
                  counts.push(0);
                }
              });
      
              var year = currentMonth.getFullYear();
              var yearLink = "<a class='chartTitleLink' href='#yearstats/" + Date.parse("Jan 01 " + year).getTime() + "'>" + year + "</a>";
              var quarter = getQuarter(currentMonth);
              var chartTitle;
              if (numOfMonths == 3) {
                chartTitle = "<strong>" + "Q" + quarter.number + "</strong>" + " (" + yearLink + ")";
              }
              else {
                var quarterLink = "<a class='chartTitleLink' href='#quarterstats/" + quarter.date + "'>" + "Q" + quarter.number + "</a>";
                chartTitle = "<strong>" + currentMonth.toString("MMMM") + "</strong>" + " (" + quarterLink + " - " + yearLink + ")";
              }
              $("#loginStatsChartTitle").html(chartTitle);
              drawChart($("#loginStatsChart"), counts, weeks.map(function(x){return "w" + x}));
              $("#stats").html("__MSG_loginHistory.averagePerWeek__: " + (counted == 0 ? 0 : (counts.sum()/counted)).toFixed(2));
              gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
            });
            
            $("#prevBtn").unbind();
            $("#prevBtn").click(function(){
              currentMonth.addMonths(-numOfMonths);
              showWeeklyStats(userId, currentMonth.getTime(), numOfMonths);
            })
            
            $("#nextBtn").unbind();
            $("#nextBtn").click(function(){
              currentMonth.addMonths(numOfMonths);
              showWeeklyStats(userId, currentMonth.getTime(), numOfMonths);
            })
      
            $("#loginStatsChart").unbind();
            
            $("#loginStatsChart").bind('jqplotDataClick',
              function (ev, seriesIndex, pointIndex, data) {
                $(this).css('cursor','auto');
                var weekNum = weeks[pointIndex];
                var yearOfWeek = currentMonth.getFullYear();
                if(pointIndex == 0 && weekNum >= 52) yearOfWeek--;
                if(pointIndex == weeks.length-1 && weekNum == 1) yearOfWeek++;
                var weekDay = Date.today().set({year:yearOfWeek}).setWeek(weekNum);
                showDailyStats(userId, weekDay.getTime());
              }
            );
      
            $('#loginStatsChart').bind('jqplotDataHighlight',
                function (ev, seriesIndex, pointIndex, data ) {
                    mouseX = ev.pageX;
                    mouseY = ev.pageY;
                    
                    var weekNum = weeks[pointIndex];
                    var yearOfWeek = currentMonth.getFullYear();
                    if(pointIndex == 0 && weekNum >= 52) yearOfWeek--;
                    if(pointIndex == weeks.length-1 && weekNum == 1) yearOfWeek++;
                    var weekDay = Date.today().set({year:yearOfWeek}).setWeek(weekNum);
                              
                    $('#chartTooltipDiv').html(weekDay.toString("MMM dd, yyyy"));
                    $('#chartTooltipDiv').fadeIn();
                    var cssObj = {
                          'position' : 'absolute',
                          'left' : mouseX + 'px',
                          'top' : mouseY-15 + 'px'
                        };
                    $('#chartTooltipDiv').css(cssObj);
                    $(this).css('cursor','pointer');
                }
            );
      
            $('#loginStatsChart').bind('jqplotDataUnhighlight',
                function (ev) {
                    $('#chartTooltipDiv').html('');
                    $('#chartTooltipDiv').hide();
                    $(this).css('cursor','auto');
                }
            );
          }
          
          function showMonthlyStats(userId, year){
            var currentYear = new Date(year);
            var restURI = "/rest/loginhistory/yearstats/"+ userId + "/" + currentYear.toString("yyyy-MM-dd");
            $.getJSON(restURI, function(userLoginCountJson){
              var loginCountPerMonths = userLoginCountJson.data[1];
              // var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        // 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              var months = new Array();
              var counts = new Array();
              var counted = 0;
              $.each(loginCountPerMonths, function(i, loginCountPerMonth){
                months.push(new Date(loginCountPerMonth.loginDate).toString("MMM"));
                if(loginCountPerMonth.loginCount != -1){
                  counts.push(loginCountPerMonth.loginCount);
                  counted++;
                } else{
                  counts.push(0);
                }
              });
      
              var chartTitle = "<strong>" + currentYear.getFullYear() + "</strong>";
              $("#loginStatsChartTitle").html(chartTitle);
              drawChart($("#loginStatsChart"), counts, months);
              $("#stats").html("__MSG_loginHistory.averagePerMonth__: " + (counted == 0 ? 0 : (counts.sum()/counted)).toFixed(2));
              gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
            });
                  
            $("#prevBtn").unbind();
            $("#prevBtn").click(function(){
              currentYear.last().january();
              showMonthlyStats(userId, currentYear.getTime());
            })
            
            $("#nextBtn").unbind();
            $("#nextBtn").click(function(){
              currentYear.next().january();
              showMonthlyStats(userId, currentYear.getTime());
            })
      
            $("#loginStatsChart").unbind();
                    
            $("#loginStatsChart").bind('jqplotDataClick',
              function (ev, seriesIndex, pointIndex, data) {
                $(this).css('cursor','auto');
                showWeeklyStats(userId, Date.today().set({year:currentYear.getFullYear(), month:pointIndex, day:1}).getTime(), 1);
              }
            );
            
            $('#loginStatsChart').bind('jqplotDataHighlight',
                function (ev, seriesIndex, pointIndex, data ) {
                    $(this).css('cursor','pointer');
                }
            );
      
            $('#loginStatsChart').bind('jqplotDataUnhighlight',
                function (ev) {
                    $(this).css('cursor','auto');
                }
            );
          }
      
      
          function showStatistic(userId){
            $("#statisticDiv").show();
            $("#userLoginDataPosition").show();
            showDailyStats(userId, ((Date.today().is().sunday()) ? Date.last().monday() : Date.monday()).getTime());
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          }
              
          function showHistory(userId, day){
            $("#historyDiv").show();
            $("#todayHeader a span").text("__MSG_loginHistory.today__");
            $("#earlierThisWeekHeader a span").text('__MSG_loginHistory.earlierThisWeek__');
            $("#earlierThisMonthHeader a span").text('__MSG_loginHistory.earlierThisMonth__');
            $("#earlierHeader a span").text('__MSG_loginHistory.earlier__');
            $("#selectedDayHeaderContainer").hide();
            showTodayLogins(userId);
            showEarlierThisWeekLogins(userId);
            showEarlierThisMonthLogins(userId);
            showEarlierLogins(userId);
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          }
          
          
          
          function showLoginHistory(){
            isFinding = false;
            document.getElementById("searchTxt").value = "";
            
            var restURI = "/rest/loginhistory/lastlogins/5/%25";            
            $.getJSON(restURI, function(lastLoginsJson){
              $lastLoginsDataBackup = $("#lastLoginsDataDiv").clone();
              lastLogins2html(lastLoginsJson);              
              if ($(".iconDetail").closest("div.iteamIcon").hasClass("selectIteam"))
                $(".iconDetail").click();
              if ($(".iconStastic").closest("div.iteamIcon").hasClass("selectIteam"))
                $(".iconStastic").click();
            });                        
            
            $("#searchTxt").keypress(function(event){
              if ( event.which == 13 ) {
                isFinding = true;
                var userId = $("#searchTxt").val();
                if($.trim(userId).length == 0)
                  userId = "%25";
                var restURI = "/rest/loginhistory/lastlogins/0/" + userId;
                $.getJSON(restURI, function(lastLoginsJson){
                  lastLogins2html(lastLoginsJson);
                  gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
                });
              }
            });
            
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          }
      
              
              
              $("#latestBtn").click(function(){
                isFinding = false;
                document.getElementById("searchTxt").value = "";
                var restURI = "/rest/loginhistory/lastlogins/5/%25";
                $.getJSON(restURI, function(lastLoginsJson){
                  lastLogins2html(lastLoginsJson);
                  gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
                });
              });
              
      
              $("body").delegate(".statsLink", "click", function(){
                selectedUser = $(this).closest("tr").attr("id");
                selectedUserName = $(this).closest("td").siblings(":first").text();
                showStatistic(selectedUser);
                gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
              });
      
              $("body").delegate(".hisLink", "click", function(){
                selectedUser = $(this).closest("tr").attr("id");
                selectedUserName = $(this).closest("td").siblings(":first").text();
                showHistory(selectedUser);
                gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
              });
            
            $("body").delegate(".detailUser", "click", function(){
              selectedUser = $(this).closest("tr").attr("id");
              selectedUserName=$(this).text();
              showDetailCurrentUser();
              gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight+300);
             
            });
          
          function showDetailCurrentUser(){
            $("fieldset legend.StyleLegend").text(selectedUserName);
            $("#userLoginHistoryFieldset").show();
            //showStatistic(selectedUser);
            $(".iconStastics").click();
          }
          
          $("body").delegate(".iconStastics", "click", function(){
            showStatistic(selectedUser);
            $("#historyDiv").hide();
            $(".iconDetail").closest("div.iteamIcon").removeClass("selectIteam");
           var itemSelected=$(this).closest("div.iteamIcon");
           if($(itemSelected).attr("class").indexOf("selectIteam")<0) {
            $(itemSelected).addClass("selectIteam");
            }
          });
        
        $("body").delegate(".iconDetail", "click", function(){
          $("#statisticDiv").hide();
          $(".iconStastics").closest("div.iteamIcon").removeClass("selectIteam");
          var itemSelected=$(this).closest("div.iteamIcon");
          if($(itemSelected).attr("class").indexOf("selectIteam")<0) {
            $(itemSelected).addClass("selectIteam");
            }
          showHistory(selectedUser);
        });
       
              $("body").delegate(".userNameLink", "click", function(){
                selectedUser = $(this).attr("id");
                selectedUserName = $(this).text();
                showHistory(selectedUser);
                gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
              });
      
           $("body").delegate("#globalLastLoginBtn", "click", function(){           
              selectedUser = "AllUsers", selectedUserName = "__MSG_loginHistory.allUsers__";
              $(this).addClass("active");
              $("#globalStatisticBtn").removeClass("active");
              $("#globalHistoryBtn").removeClass("active");
              if($("#userLoginDataPosition #statisticDiv").length==0) {
              $("#statisticDiv").appendTo($("#userLoginDataPosition"));
              }
              if($("#userLoginDataPosition #historyDiv").length==0) {
              $("#historyDiv").appendTo($("#userLoginDataPosition"));
              }
              $("#userLoginHistoryFieldset").hide();
              $("#lastLoginsDiv").show();
              
              showLoginHistory();
            });
           
           $("body").delegate("#globalStatisticBtn", "click", function(){
                selectedUser = "AllUsers";
                selectedUserName = "__MSG_loginHistory.allUsers__";
                $(this).addClass("active");
                $("#globalLastLoginBtn").removeClass("active");
                $("#globalHistoryBtn").removeClass("active");
                
                if($("#statisticDivPosition #statisticDiv").length==0) {
                $("#statisticDiv").appendTo($("#statisticDivPosition"));
                }
                $("#lastLoginsDiv").hide();
                $("#userLoginHistoryFieldset").hide();
                $("#historyDiv").hide();
                $("#statisticDiv").show();
                showStatistic(selectedUser);
              });
           
           $("body").delegate("#globalHistoryBtn", "click", function(){
                $(this).addClass("active");
                $("#globalLastLoginBtn").removeClass("active");
                $("#globalStatisticBtn").removeClass("active");
                selectedUser = "AllUsers";
                selectedUserName = "__MSG_loginHistory.allUsers__";
                if($("#historyDivPosition #historyDiv").length==0) {
                $("#historyDiv").appendTo($("#historyDivPosition"));
                }
                $("#statisticDiv").hide();
                $("#userLoginHistoryFieldset").hide();
                $("#lastLoginsDiv").hide();
                $("#historyDivPosition").show();
                showHistory(selectedUser);
              });
      
              
              $("body").delegate(".chartTitleLink", "click", function(){
                var href = $(this).attr("href").split("/");
                switch(href[0]){
                  case "#monthstats":
                    showWeeklyStats(selectedUser, parseInt(href[1]), 1);
                    break;
                  case "#yearstats":
                    showMonthlyStats(selectedUser, parseInt(href[1]));
                    break;
                  case "#quarterstats":
                    showWeeklyStats(selectedUser, parseInt(href[1]), 3);
                    break;
                  default:
                    break;
                }
              });
    
          $("body").delegate('.collapse','shown',function(){
            $(this).prev().find(".accordion-toggle").removeClass("collapsed");
            $(this).prev().find(".accordion-toggle").addClass("expaned");  
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          });   
             
          $("body").delegate('.collapse','hidden',function(){
            $(this).prev().find(".accordion-toggle").removeClass("expaned");
            $(this).prev().find(".accordion-toggle").addClass("collapsed");
            //bootstrap2.2's bug: fire hidden event at not right moment, so the gadget couldnt resize
            gadgets.window.adjustHeight($("#LoginHistoryGadgetDiv").get(0).offsetHeight);
          });
                   
          
          
          $(function(){
            $("#globalLastLoginBtn").click();            
            $(document).everyTime("30s", "reloadPage", function() {
              if ($("#lastLoginsDiv").is(":visible") && !isFinding) {
                showLoginHistory();
              }
            },0);            
           
          });          
          
        </script>
      </head>
        
      <body style="font-size:70%;">
        <div id="LoginHistoryGadgetDiv" class="uiGadgetThemes uiBox">
          
          <h6 class="title">__MSG_loginHistory.title__</h6>
          
          <div id="GadgetContent" class="uiContentBox">
          <div class="gadContent">
            <div class="uiTabSelectorCenter">
        		  <div class="btn-group">
  	            <button id="globalLastLoginBtn" class="btn">__MSG_loginHistory.title__</button>
  	            <button id='globalStatisticBtn' class="btn">__MSG_loginHistory.statisticsView__</button>
  	            <button id='globalHistoryBtn' class="btn">__MSG_loginHistory.historyView__</button>
  	          </div>
            </div>
	          <div id="lastLoginsDiv">
	            <input class="searchUser" id="searchTxt" type="text" placeholder="__MSG_loginHistory.search_user__" name="titleInput">
	            <div id="lastLoginsContainerDiv">
	              <div id="lastLoginsDataDiv">
	                <table id="lastLoginsTable" class="uiGrid table table-hover table-striped">
	                <thead>
	                <tr>
	                  <th>__MSG_loginHistory.user__ <i class="uiIcon_ pull-right"></i></th>
	                    <th>__MSG_loginHistory.lastLogin__  <i class="uiIcon_ pull-right"></i></th>
	                    <th>__MSG_loginHistory.beforeThat__  <i class="uiIcon_ pull-right"></i></th>
	                </tr>
	              </thead>
	                </table>
	              </div>
	            </div>
	          </div>
	    
	          <fieldset id="userLoginHistoryFieldset" style="display:none;" class="userForm">
	             <legend class="StyleLegend">John Smith &nbsp; &nbsp;</legend>
	             <div class="userContent clearfix">
	                 <div class="leftContent pull-left">
	                       <div class="selectIteam iteamIcon"><i class="iconStastics"></i><span class="caret"></span></div>
	                       <div class="iteamIcon"><i class="iconDetail"></i></div>
	                 </div>
	                 <div id="userLoginDataPosition"  class="rightContent">
	               
	                 
	                   <div id="statisticDiv" class="statisticDiv">
	                 <div class="clearfix selectWeek">
	                   <button class="pull-right btn"> Week <i class="uiIconMiniArrowDown"></i></button>
	                   <div class='btn-group'>
	                     <button class="btn" id="prevBtn" rel="tooltip" data-placement="bottom" title="Preview" >&nbsp;<i class="uiIconArrowLeft"></i>&nbsp;</button>
	                     <button class="btn" id="loginStatsChartTitle">Week 44</button>
	                     <button class="btn" id="nextBtn" rel="tooltip" data-placement="bottom" title="Next">&nbsp;<i class="uiIconArrowRight"></i>&nbsp;</button>
	                   </div>
	                 </div>
	                 <div id="loginStatsChart" style="height:150px;"></div>
	                 <div id="chartTooltipDiv" class="jqplot-highlighter-tooltip"></div>
	                 <div id="stats" style="margin-top: 10px; margin-left: 12px;"></div>
	                 </div>
	                 
	                 
	                 <div  id="historyDiv" class="accordion">                 
	                       <div class="accordion-group">
	                           <div class="accordion-heading">
	                             <div id="todayHeader" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#historyDiv" href="#todayDiv">
	                                    <a href="#" id=""><i class='uiIconSelected pull-right'></i><span>__MSG_loginHistory.today__</span></a>
	                             </div>
	                           </div>
	                         <div id="todayDiv" class="accordion-body collapse" style="overflow-y: auto;">
	                           </div>
	                       </div>
	                   
	                       <div class="accordion-group">
	                       <div class="accordion-heading">
	                         <div  id="earlierThisWeekHeader" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#historyDiv" href="#earlierThisWeekDiv">
	                       <a id="" href="#"><i class='uiIconSelected pull-right'></i><span>__MSG_loginHistory.earlierThisWeek__</span></a>
	                         </div>
	                       </div>
	                       <div id="earlierThisWeekDiv" class="accordion-body collapse" style="overflow-y: auto;"> </div>
	                       </div>
	                       
	                       <div class="accordion-group">
	                       <div class="accordion-heading">
	                         <div id="earlierThisMonthHeader" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#historyDiv" href="#earlierThisMonthDiv">
	                          <a id="" href="#"><i class='uiIconSelected pull-right'></i><span>__MSG_loginHistory.earlierThisMonth__</span></a>
	                         </div>
	                       </div>
	                       <div id="earlierThisMonthDiv" class="accordion-body collapse" style="overflow-y: auto;"> </div>
	                       </div>
	                       
	                       
	                       <div class="accordion-group">
	                       <div class="accordion-heading">
	                         <div id="earlierHeader" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#historyDiv" href="#earlierDiv">
	                            <a id="" href="#"><i class='uiIconSelected pull-right'></i><span>__MSG_loginHistory.earlier__</span></a>
	                         </div>
	                       </div>
	                       <div id="earlierDiv" class="accordion-body collapse" style="overflow-y: auto;"> </div>
	                       </div>
	                     </div>
	                     
	                 </div>
	                 
	                 
	                 
	             </div>
	        </fieldset>
	        <div id="statisticDivPosition">   
	     
	        </div>
	 
	        <div id="historyDivPosition" class="historyDivPosition">
	      </div>
      
      	</div>
        </div>
                   
      </body>
    ]]></Content>
</Module>